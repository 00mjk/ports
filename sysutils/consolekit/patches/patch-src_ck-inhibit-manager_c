$OpenBSD: patch-src_ck-inhibit-manager_c,v 1.4 2020/12/04 16:01:00 ajacoutot Exp $

From 5d9925bae370cc1edc260909a55b44f6550294f1 Mon Sep 17 00:00:00 2001
From: Robert Nagy <robert@openbsd.org>
Date: Sun, 29 Nov 2020 12:15:20 +0100
Subject: [PATCH] change the inhibitor lock handling to use the named_pipe_path as a reference

From e8960c0fb789e1ddefe5b4cbfcde4861f7fa3169 Mon Sep 17 00:00:00 2001
From: Robert Nagy <robert@openbsd.org>
Date: Fri, 4 Dec 2020 15:21:14 +0100
Subject: [PATCH] only disconnect the signal handler after the lock is removed

Index: src/ck-inhibit-manager.c
--- src/ck-inhibit-manager.c.orig
+++ src/ck-inhibit-manager.c
@@ -152,7 +152,7 @@ cb_changed_event (CkInhibit *inhibit,
 
                 /* When an inhibitor loses it lockes, remove the inhibitor from
                  * the list */
-                ck_inhibit_manager_remove_lock (manager, ck_inhibit_get_who (inhibit));
+                ck_inhibit_manager_remove_lock (manager, ck_inhibit_get_named_pipe_path (inhibit));
         }
 }
 
@@ -235,8 +235,7 @@ ck_inhibit_manager_create_lock (CkInhibitManager *mana
 /**
  * ck_inhibit_manager_remove_lock:
  * @manager: The @CkInhibitManager object
- * @who:  A human-readable, descriptive string of who has taken
- *        the lock. Example: "Xfburn"
+ * @named_pipe_path:  The unique named pipe path to lock on.
  *
  * Finds the inhibit lock @who and removes it.
  *
@@ -244,7 +243,7 @@ ck_inhibit_manager_create_lock (CkInhibitManager *mana
  **/
 gboolean
 ck_inhibit_manager_remove_lock (CkInhibitManager *manager,
-                                const gchar      *who)
+                                const gchar      *named_pipe_path)
 {
         CkInhibitManagerPrivate *priv;
         GList                   *l;
@@ -256,15 +255,15 @@ ck_inhibit_manager_remove_lock (CkInhibitManager *mana
         priv = CK_INHIBIT_MANAGER_GET_PRIVATE (manager);
 
         for (l = g_list_first (priv->inhibit_list); l != NULL; l = l->next) {
-                if (l->data && g_strcmp0 (ck_inhibit_get_who (l->data), who) == 0) {
+                if (l->data && g_strcmp0 (ck_inhibit_get_named_pipe_path (l->data), named_pipe_path) == 0) {
                         CkInhibit *inhibit = l->data;
 
                         /* Found it! Remove it from the list and unref the object */
                         priv->inhibit_list = g_list_remove (priv->inhibit_list, inhibit);
+                        ck_inhibit_remove_lock (inhibit);
                         g_signal_handlers_disconnect_by_func (inhibit,
                                                               G_CALLBACK (cb_changed_event),
                                                               manager);
-                        ck_inhibit_remove_lock (inhibit);
                         g_object_unref (inhibit);
                         return TRUE;
                 }
