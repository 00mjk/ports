$OpenBSD: patch-src_script_c,v 1.5 2021/07/02 10:27:11 sthen Exp $

From 39b397dddda51d45958ced162cf1c7a589f65866 Mon Sep 17 00:00:00 2001
From: Roy Marples <roy@marples.name>
Date: Mon, 18 Jan 2021 11:31:05 +0000
Subject: [PATCH] script: Use rt_proto_add to ensure no duplicate interfaces on
 OpenBSD

OpenBSD allows matching priorities, so we need to take the interfaces
in the order given to ensure uniqueness.

Index: src/script.c
--- src/script.c.orig
+++ src/script.c
@@ -390,6 +390,7 @@ make_env(struct dhcpcd_ctx *ctx, const struct interfac
 	if (ifp->ctx->options & DHCPCD_DUMPLEASE)
 		goto dumplease;
 
+	ifp->ctx->rt_order = 0;
 	rb_tree_init(&ifaces, &rt_compare_proto_ops);
 	TAILQ_FOREACH(ifp2, ifp->ctx->ifaces, next) {
 		if (!ifp2->active)
@@ -397,7 +398,7 @@ make_env(struct dhcpcd_ctx *ctx, const struct interfac
 		rt = rt_new(UNCONST(ifp2));
 		if (rt == NULL)
 			goto eexit;
-		if (rb_tree_insert_node(&ifaces, rt) != rt)
+		if (rt_proto_add(&ifaces, rt) != rt)
 			goto eexit;
 	}
 	if (fprintf(fp, "interface_order=") == -1)
