$OpenBSD: patch-daemon_gdm-local-display-factory_c,v 1.17 2021/05/29 14:02:24 ajacoutot Exp $

Index: daemon/gdm-local-display-factory.c
--- daemon/gdm-local-display-factory.c.orig
+++ daemon/gdm-local-display-factory.c
@@ -28,7 +28,9 @@
 #include <glib-object.h>
 #include <gio/gio.h>
 
+#if 0
 #include <systemd/sd-login.h>
+#endif
 
 #include "gdm-common.h"
 #include "gdm-manager.h"
@@ -376,7 +378,7 @@ on_display_status_changed (GdmDisplay             *dis
                         /* reset num failures */
                         factory->num_failures = 0;
 
-                        gdm_local_display_factory_sync_seats (factory);
+                        ensure_display_for_seat (factory, seat_id);
                 }
                 break;
         case GDM_DISPLAY_FAILED:
@@ -482,7 +484,7 @@ ensure_display_for_seat (GdmLocalDisplayFactory *facto
         GdmDisplay      *display = NULL;
         g_autofree char *login_session_id = NULL;
 
-        ret = sd_seat_can_graphical (seat_id);
+        ret = 1;
 
         if (ret < 0) {
                 g_critical ("Failed to query CanGraphical information for seat %s", seat_id);
@@ -576,6 +578,7 @@ ensure_display_for_seat (GdmLocalDisplayFactory *facto
                 return;
         }
 
+#if 0
         /* If we already have a login window, switch to it */
         if (gdm_get_login_window_session_id (seat_id, &login_session_id)) {
                 GdmDisplay *display;
@@ -593,6 +596,7 @@ ensure_display_for_seat (GdmLocalDisplayFactory *facto
                         return;
                 }
         }
+#endif
 
         g_debug ("GdmLocalDisplayFactory: Adding display on seat %s", seat_id);
 
@@ -746,7 +750,7 @@ on_seat_properties_changed (GDBusConnection *connectio
         if (!changed)
                 return;
 
-        ret = sd_seat_can_graphical (seat);
+        ret = 1;
         if (ret < 0)
                 return;
 
@@ -768,6 +772,7 @@ lookup_by_session_id (const char *id,
         return g_strcmp0 (current, looking_for) == 0;
 }
 
+#if 0
 static gboolean
 lookup_by_tty (const char *id,
               GdmDisplay *display,
@@ -790,6 +795,7 @@ lookup_by_tty (const char *id,
 
         return g_strcmp0 (tty_to_check, tty_to_find) == 0;
 }
+#endif
 
 #if defined(ENABLE_USER_DISPLAY_SERVER)
 static void
@@ -1097,8 +1103,8 @@ gdm_local_display_factory_start (GdmDisplayFactory *ba
                                  factory,
                                  0);
 
-        gdm_local_display_factory_start_monitor (factory);
-        return gdm_local_display_factory_sync_seats (factory);
+        ensure_display_for_seat (factory, "/org/freedesktop/ConsoleKit/Seat1");
+        return TRUE;
 }
 
 static gboolean
