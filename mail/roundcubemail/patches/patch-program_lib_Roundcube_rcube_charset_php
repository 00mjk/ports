$OpenBSD: patch-program_lib_Roundcube_rcube_charset_php,v 1.1 2021/10/29 14:00:00 sthen Exp $

From ca0cce0e11800adb5e7def6141a30b9a19dfaf5c Mon Sep 17 00:00:00 2001
From: Aleksander Machniak <alec@alec.pl>
Date: Thu, 28 Oct 2021 14:09:29 +0200
Subject: [PATCH] Fix charset conversion errors on PHP < 8 for charsets not
 supported by mbstring (#8252)

Index: program/lib/Roundcube/rcube_charset.php
--- program/lib/Roundcube/rcube_charset.php.orig
+++ program/lib/Roundcube/rcube_charset.php
@@ -281,7 +281,7 @@ class rcube_charset
         }
 
         $out = false;
-        $error_handler = function() use ($out) { $out = false; };
+        $error_handler = function() { throw new \Exception(); };
 
         // Ignore invalid characters
         $mbstring_sc = mb_substitute_character();
@@ -328,10 +328,14 @@ class rcube_charset
             // If iconv reports an illegal character in input it means that input string
             // has been truncated. It's reported as E_NOTICE.
             // PHP8 will also throw E_WARNING on unsupported encoding.
-            set_error_handler($error_handler, E_NOTICE);
-            set_error_handler($error_handler, E_WARNING);
+            set_error_handler($error_handler, E_NOTICE | E_WARNING);
 
-            $out = iconv($from, $to . $iconv_options, $str);
+            try {
+                $out = iconv($from, $to . $iconv_options, $str);
+            }
+            catch (Throwable $e) {
+                $out = false;
+            }
 
             restore_error_handler();
 
