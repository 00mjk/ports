$OpenBSD: patch-program_lib_Roundcube_rcube_addressbook_php,v 1.1 2021/10/29 14:00:00 sthen Exp $

From d73d81032f12bafa691b8f74c50b9bd7caf75606 Mon Sep 17 00:00:00 2001
From: Aleksander Machniak <alec@alec.pl>
Date: Thu, 21 Oct 2021 19:52:04 +0200
Subject: [PATCH] Fix some PHP8 warnings (#8239)

Index: program/lib/Roundcube/rcube_addressbook.php
--- program/lib/Roundcube/rcube_addressbook.php.orig
+++ program/lib/Roundcube/rcube_addressbook.php
@@ -685,20 +685,34 @@ abstract class rcube_addressbook
         static $compose_mode;
 
         if (!isset($compose_mode)) {
-            $compose_mode = rcube::get_instance()->config->get('addressbook_name_listing', 0);
+            $compose_mode = (int) rcube::get_instance()->config->get('addressbook_name_listing', 0);
         }
 
+        $get_names = function ($contact, $fields) {
+            $result = [];
+            foreach ($fields as $field) {
+                if (!empty($contact[$field])) {
+                    $result[] = $contact[$field];
+                }
+            }
+            return $result;
+        };
+
         switch ($compose_mode) {
         case 3:
-            $fn = implode(' ', [$contact['surname'] . ',', $contact['firstname'], $contact['middlename']]);
+            $names = $get_names($contact, ['firstname', 'middlename']);
+            if (!empty($contact['surname'])) {
+                array_unshift($names, $contact['surname'] . ',');
+            }
+            $fn = implode(' ', $names);
             break;
         case 2:
             $keys = ['surname', 'firstname', 'middlename'];
-            $fn   = implode(' ', array_filter(array_intersect_key($contact, array_flip($keys))));
+            $fn   = implode(' ', $get_names($contact, $keys));
             break;
         case 1:
             $keys = ['firstname', 'middlename', 'surname'];
-            $fn   = implode(' ', array_filter(array_intersect_key($contact, array_flip($keys))));
+            $fn   = implode(' ', $get_names($contact, $keys));
             break;
         case 0:
             if (!empty($contact['name'])) {
@@ -706,7 +720,7 @@ abstract class rcube_addressbook
             }
             else {
                 $keys = ['prefix', 'firstname', 'middlename', 'surname', 'suffix'];
-                $fn   = implode(' ', array_filter(array_intersect_key($contact, array_flip($keys))));
+                $fn   = implode(' ', $get_names($contact, $keys));
             }
             break;
         default:
@@ -720,7 +734,7 @@ abstract class rcube_addressbook
         // fallbacks...
         if ($fn === '') {
             // ... display name
-            if ($name = trim($contact['name'])) {
+            if (isset($contact['name']) && ($name = trim($contact['name']))) {
                 $fn = $name;
             }
             // ... organization
