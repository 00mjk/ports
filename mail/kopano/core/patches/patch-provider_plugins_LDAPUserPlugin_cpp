$OpenBSD: patch-provider_plugins_LDAPUserPlugin_cpp,v 1.1 2021/11/04 17:11:23 robert Exp $

commit 83f9273b7fe394bf4b20f83fefc5ffb079f131ac
Author: João Gouveia <j.gouveia@kopano.com>
Date:   Fri Apr 23 04:09:11 2021 +1400

    Add a global convert_context to each thread.
    
commit 68c6f76fa1d572e58ce123311374e4bc1381265e
Author: João Gouveia <j.gouveia@kopano.com>
Date:   Fri Apr 23 05:12:31 2021 +1400

    Add a function to create a new iconv_context

Index: provider/plugins/LDAPUserPlugin.cpp
--- provider/plugins/LDAPUserPlugin.cpp.orig
+++ provider/plugins/LDAPUserPlugin.cpp
@@ -473,21 +473,7 @@ void LDAPUserPlugin::InitPlugin(std::shared_ptr<ECStat
 
 	/* FIXME encode the user and password, now it depends on which charset the config is saved in */
 	m_ldap = ConnectLDAP(nullptr, nullptr);
-
-	const char *ldap_server_charset = m_config->GetSetting("ldap_server_charset");
-	try {
-		new_iconv_context_if_not_exists<std::string, std::string>("UTF-8", ldap_server_charset);
-	} catch (const convert_exception &e) {
-		throw ldap_error(format("Cannot convert %s to UTF-8: %s", ldap_server_charset, e.what()));
-	}
-
-	try {
-		new_iconv_context_if_not_exists<std::string, std::string>(ldap_server_charset, "UTF-8");
-	} catch (const convert_exception &e) {
-		throw ldap_error(format("Cannot convert UTF-8 to %s: %s", ldap_server_charset, e.what()));
-	}
-
-	m_charset = ldap_server_charset;
+	m_charset = m_config->GetSetting("ldap_server_charset");
 }
 
 int LDAPUserPlugin::setup_ldap(const char *server, bool tls, LDAP **ldp)
